<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>1 MG Trader | Order Booking Portal</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #2c3e50; --accent: #f39c12; --success: #27ae60; --danger: #e74c3c; }
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; padding-bottom: 60px; }
        
        .main-header { background: var(--primary); color: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; }
        .log-badge { background: var(--accent); color: var(--primary); padding: 5px 15px; border-radius: 20px; font-weight: bold; font-size: 14px; }
        
        .order-container { max-width: 1200px; margin: 20px auto; padding: 0 20px; display: grid; grid-template-columns: 1fr 380px; gap: 20px; }
        .order-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        /* Your Requested Layout Colors */
        .input-group { background: #f8f9fa; border-radius: 10px; padding: 15px; margin-bottom: 15px; border-left: 5px solid var(--primary); }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }
        
        input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-top: 5px; }
        .btn-add { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; width: 100%; font-weight: bold; }
        .btn-save { background: var(--success); color: white; border: none; padding: 15px; border-radius: 10px; width: 100%; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 20px; }

        /* Item Table */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { background: #eee; padding: 10px; text-align: left; font-size: 13px; }
        td { padding: 10px; border-bottom: 1px solid #eee; }

        /* Footer Warning Ticker */
        .footer-ticker { position: fixed; bottom: 0; width: 100%; background: #c0392b; color: white; padding: 10px 0; overflow: hidden; z-index: 1000; }
        .ticker-content { display: inline-block; white-space: nowrap; animation: marquee 25s linear infinite; }
        @keyframes marquee { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
    </style>
</head>
<body>

<div class="main-header">
    <div class="log-badge" id="logDisplay">Log by ...</div>
    <h2 style="margin:0;">1 MG TRADER</h2>
    <button onclick="logout()" style="background:var(--danger); color:white; border:none; padding:5px 15px; border-radius:5px; cursor:pointer;">Logout</button>
</div>

<div class="order-container">
    <div class="order-card">
        <div class="input-group">
            <h4 style="margin:0 0 10px 0;"><i class="fa fa-user"></i> Customer & Booker Details</h4>
            <div class="grid-3">
                <div><label>üìÖ Order Date</label><input type="date" id="orderDate"></div>
                <div><label>üîë Booker ID</label><input type="text" id="bookerId" readonly></div>
                <div><label>üè™ Shop Name</label><input type="text" id="shopName" placeholder="Enter Mart Name"></div>
                <div><label>üì± Mobile Number</label><input type="text" id="shopPhone" placeholder="03xx-xxxxxxx"></div>
                <div style="grid-column: span 2;"><label>üìç Delivery Address</label><input type="text" id="shopAddress" placeholder="Full Location"></div>
            </div>
        </div>

        <div class="input-group" style="border-left-color: var(--accent);">
            <h4 style="margin:0 0 10px 0;"><i class="fa fa-shopping-cart"></i> Add Products</h4>
            <div style="display:grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr auto; gap:10px; align-items: end;">
                <div><label>Item Name / Code</label>
                    <input list="prodList" id="pSearch" onchange="autoFillPrice()" placeholder="Search Code/Name...">
                    <datalist id="prodList"></datalist>
                </div>
                <div><label>Price</label><input type="number" id="pPrice" readonly></div>
                <div><label>Qty</label><input type="number" id="pQty" value="1"></div>
                <div><label>Disc %</label><input type="number" id="pDisc" value="0"></div>
                <div><label>Bonus</label><input type="number" id="pBonus" value="0" placeholder="Qty"></div>
                <button class="btn-add" onclick="addItem()">‚ûï ADD</button>
            </div>
        </div>

        <table>
            <thead><tr><th>Item</th><th>Price</th><th>Qty</th><th>Disc</th><th>Bonus</th><th>Total</th><th>Action</th></tr></thead>
            <tbody id="cartTable"></tbody>
        </table>
        <h2 style="text-align:right; color:var(--primary);">Grand Total: Rs. <span id="grandTotal">0</span></h2>
        <button class="btn-save" onclick="saveOrder()">üöÄ SAVE ORDER</button>
    </div>

    <div class="order-card">
        <h3>üìã Order History</h3>
        <div id="historyPanel" style="max-height: 500px; overflow-y: auto;">
            <p style="text-align:center; color:#999;">No history available.</p>
        </div>
    </div>
</div>

<div class="footer-ticker">
    <div class="ticker-content" id="warningTicker">Loading system alerts...</div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, onSnapshot, doc, setDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyD3So-in02rbcWD7OmuiRXzySQYgCR7iVI",
        authDomain: "mg-tradere.firebaseapp.com",
        projectId: "mg-tradere",
        storageBucket: "mg-tradere.firebasestorage.app",
        messagingSenderId: "318790809953",
        appId: "1:318790809953:web:5e829277f6d161e9942d20"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let allProducts = [];
    let cart = [];

    // --- Authentication & Identity Logic ---
    window.onload = () => {
        const user = sessionStorage.getItem("loggedUser");
        if(!user) { window.location.href = "login.html"; return; }
        
        document.getElementById('logDisplay').innerText = "Log by " + user;
        document.getElementById('bookerId').value = user.toUpperCase();
        document.getElementById('orderDate').valueAsDate = new Date();
        loadProducts();
        loadHistory();
    };

    // --- Real-time Stock & Warning Ticker ---
    function loadProducts() {
        onSnapshot(collection(db, "products"), (snap) => {
            const list = document.getElementById('prodList');
            const ticker = document.getElementById('warningTicker');
            list.innerHTML = "";
            let warnings = [];
            allProducts = [];

            snap.forEach(d => {
                const p = d.data(); p.id = d.id;
                allProducts.push(p);
                list.innerHTML += `<option value="${p.code} | ${p.name}">Stock: ${p.qty}</option>`;
                
                if(p.qty <= p.min) warnings.push(`‚ö†Ô∏è LOW STOCK: ${p.name} (${p.qty} left)`);
                // Expiry Check (Simplified)
                if(p.expiry && new Date(p.expiry) < new Date(Date.now() + 30*24*60*60*1000)) {
                    warnings.push(`üî• NEAR EXPIRY: ${p.name} (Exp: ${p.expiry})`);
                }
            });
            ticker.innerText = warnings.length > 0 ? warnings.join(" | ") : "System Live: All Stock Normal üü¢";
        });
    }

    window.autoFillPrice = () => {
        const val = document.getElementById('pSearch').value.split(" | ")[0];
        const p = allProducts.find(x => x.code === val);
        if(p) document.getElementById('pPrice').value = p.sale;
    };

    window.addItem = () => {
        const val = document.getElementById('pSearch').value.split(" | ")[0];
        const p = allProducts.find(x => x.code === val);
        if(!p) return alert("Product select karein!");

        const qty = parseInt(document.getElementById('pQty').value);
        const disc = parseFloat(document.getElementById('pDisc').value);
        const bonus = parseInt(document.getElementById('pBonus').value);
        const price = parseFloat(document.getElementById('pPrice').value);
        
        const total = (price * qty) - ((price * qty) * (disc/100));
        cart.push({ name: p.name, code: p.code, price, qty, disc, bonus, total });
        
        renderCart();
        document.getElementById('pSearch').value = "";
    };

    function renderCart() {
        const body = document.getElementById('cartTable');
        body.innerHTML = "";
        let gTotal = 0;
        cart.forEach((item, i) => {
            gTotal += item.total;
            body.innerHTML += `<tr>
                <td>${item.name}</td><td>${item.price}</td><td>${item.qty}</td>
                <td>${item.disc}%</td><td>${item.bonus}</td><td>${item.total.toFixed(0)}</td>
                <td onclick="removeCart(${i})">‚ùå</td>
            </tr>`;
        });
        document.getElementById('grandTotal').innerText = gTotal.toFixed(0);
    }

    window.saveOrder = async () => {
        if(cart.length === 0) return alert("Cart khali hai!");
        const billId = "ORD-" + Date.now();
        const orderData = {
            orderId: billId,
            shop: document.getElementById('shopName').value,
            phone: document.getElementById('shopPhone').value,
            address: document.getElementById('shopAddress').value,
            booker: sessionStorage.getItem("loggedUser"),
            items: cart,
            total: cart.reduce((acc, i) => acc + i.total, 0),
            date: document.getElementById('orderDate').value,
            timestamp: Date.now()
        };
        await setDoc(doc(db, "orders", billId), orderData);
        alert("Order Booked Successfully!");
        cart = []; renderCart();
    };

    function loadHistory() {
        const q = query(collection(db, "orders"), orderBy("timestamp", "desc"));
        onSnapshot(q, (snap) => {
            const panel = document.getElementById('historyPanel');
            panel.innerHTML = "";
            snap.forEach(d => {
                const o = d.data();
                panel.innerHTML += `<div style="border-bottom:1px solid #eee; padding:10px; font-size:12px;">
                    <b>${o.shop}</b><br>Rs. ${o.total.toFixed(0)} | ${o.date}<br>
                    <small>By: ${o.booker}</small>
                </div>`;
            });
        });
    }

    window.logout = () => { sessionStorage.clear(); window.location.href="login.html"; };
</script>

</body>
</html>