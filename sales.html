<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>1 MG Trader | Professional Sales Portal</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --primary: #2c3e50; --secondary: #3498db; --success: #27ae60; --danger: #e74c3c; --warning: #f39c12; --light: #f8f9fa; }
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; padding-bottom: 80px; }
        .main-header { background: var(--primary); color: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .seller-badge { background: var(--secondary); padding: 5px 15px; border-radius: 20px; font-size: 13px; font-weight: bold; }
        .btn-logout { background: var(--danger); color: white; border: none; padding: 8px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .sales-container { display: flex; gap: 20px; padding: 20px; flex-wrap: wrap; }
        .billing-section { flex: 3; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-top: 5px solid var(--secondary); min-width: 600px; }
        .grid-inputs { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-bottom: 20px; }
        label { font-size: 11px; font-weight: bold; color: var(--secondary); text-transform: uppercase; }
        input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; margin-top: 5px; box-sizing: border-box; }
        .item-bar { background: var(--light); padding: 20px; border-radius: 12px; display: grid; grid-template-columns: 2fr 1fr 0.8fr 0.8fr 1fr; gap: 10px; align-items: end; border: 1px solid #eee; }
        .stock-label { font-size: 10px; color: var(--danger); font-weight: bold; display: block; margin-top: 2px; }
        .calc-section { width: 300px; background: #1a252f; padding: 20px; border-radius: 15px; color: white; height: fit-content; }
        .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .calc-btn { height: 50px; border-radius: 8px; border: none; font-size: 18px; cursor: pointer; background: #34495e; color: white; }
        #calc-display { width: 100%; height: 50px; font-size: 24px; text-align: right; margin-bottom: 10px; border-radius: 5px; border: none; padding: 5px; background: #fff; color: #000; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { background: #f4f7f6; padding: 12px; text-align: left; font-size: 13px; color: var(--primary); border-bottom: 2px solid #ddd; }
        td { padding: 12px; border-bottom: 1px solid #eee; font-size: 14px; }
        .total-bar { background: var(--primary); color: white; padding: 20px; border-radius: 10px; margin-top: 20px; display: flex; justify-content: space-between; align-items: center; }
        .edit-mode { background: #fff3cd !important; border: 2px solid var(--warning) !important; }
        .btn-action { border: none; background: none; cursor: pointer; font-size: 18px; margin: 0 5px; }
    </style>
</head>
<body>

<div class="main-header">
    <div style="display: flex; align-items: center; gap: 20px;">
        <h2 style="margin:0;">üõí SALES & BILLING | 1 MG TRADER</h2>
        <div class="seller-badge">üë§ Seller: <span id="sellerIDLabel">M-Haroon-123</span></div>
    </div>
   <button class="btn-logout" onclick="window.logout()">LOGOUT</button>
</div>

<div class="sales-container">
    <div class="billing-section" id="billPanel">
        <div id="editIndicator" style="display:none; background:var(--warning); color:black; padding:8px; border-radius:5px; text-align:center; font-weight:bold; margin-bottom:15px; border: 1px dashed black;">‚ö†Ô∏è MODE: EDITING INVOICE <span id="editingInvLabel"></span></div>
        
        <div class="grid-inputs">
            <div><label>Bill Date & Time</label><input type="datetime-local" id="billDate"></div>
            <div><label>Inv #</label><input type="text" id="billInv" readonly></div>
            <div><label>Customer Name</label><input type="text" id="custName" placeholder="Customer Name"></div>
            <div><label>Phone</label><input type="text" id="custPhone" placeholder="03XXXXXXXXX" maxlength="11"></div>
            <div><label>Area / Address</label><input type="text" id="custArea" placeholder="Market Name"></div>
        </div>

        <div class="item-bar">
            <div>
                <label>Search Item (Name/Code)</label>
                <input list="productList" id="itemSearch" placeholder="Type name or code..." oninput="checkPrice(this.value)" autocomplete="off">
                <datalist id="productList"></datalist>
            </div>
            <div>
                <label>Price</label>
                <input type="number" id="itemPrice" placeholder="Item Price">
                <span class="stock-label" id="stockAvailable">Stock: 0</span>
            </div>
            <div><label>Qty</label><input type="number" id="itemQty" value="1"></div>
            <div><label>Disc%</label><input type="number" id="itemDisc" value="0"></div>
            <button onclick="addToCart()" style="background:var(--success); color:white; border:none; height:42px; border-radius:6px; cursor:pointer; font-weight:bold; width: 100%;">‚ûï ADD</button>
        </div>

        <table>
            <thead>
                <tr><th>Item Description</th><th>Price</th><th>Qty</th><th>Total</th><th>X</th></tr>
            </thead>
            <tbody id="billBody"></tbody>
        </table>

        <div class="total-bar">
            <h2 style="margin:0;">Grand Total: Rs. <span id="grandTotal">0</span></h2>
            <div>
                <button onclick="saveInvoice('CASH PAID')" id="saveBtn" style="background:var(--success); padding:12px 25px; border:none; border-radius:6px; color:white; font-weight:bold; cursor:pointer;">üí∞ CASH PAID</button>
                <button onclick="saveInvoice('UDHAR')" id="udharBtn" style="background:var(--warning); padding:12px 25px; border:none; border-radius:6px; color:white; font-weight:bold; cursor:pointer; margin-left:10px;">üìù SAVE AS UDHAR</button>
                <button onclick="cancelEdit()" id="cancelBtn" style="display:none; background:var(--danger); padding:12px 25px; border:none; border-radius:6px; color:white; font-weight:bold; cursor:pointer; margin-left:10px;">CANCEL EDIT</button>
            </div>
        </div>
    </div>

    <div class="calc-section">
        <h3 style="margin-top:0;">üßÆ Calculator</h3>
        <input type="text" id="calc-display" readonly value="0">
        <div class="calc-grid">
            <button class="calc-btn" onclick="calcC()" style="background:var(--danger)">C</button>
            <button class="calc-btn" onclick="calcIn('/')">/</button><button class="calc-btn" onclick="calcIn('*')">*</button><button class="calc-btn" onclick="calcIn('-')">-</button>
            <button class="calc-btn" onclick="calcIn('7')">7</button><button class="calc-btn" onclick="calcIn('8')">8</button><button class="calc-btn" onclick="calcIn('9')">9</button><button class="calc-btn" onclick="calcIn('+')">+</button>
            <button class="calc-btn" onclick="calcIn('4')">4</button><button class="calc-btn" onclick="calcIn('5')">5</button><button class="calc-btn" onclick="calcIn('6')">6</button>
            <button class="calc-btn" onclick="calcRes()" style="background:var(--success); grid-row: span 2;">=</button>
            <button class="calc-btn" onclick="calcIn('1')">1</button><button class="calc-btn" onclick="calcIn('2')">2</button><button class="calc-btn" onclick="calcIn('3')">3</button>
            <button class="calc-btn" onclick="calcIn('0')" style="grid-column: span 2;">0</button><button class="calc-btn" onclick="calcIn('.')">.</button>
        </div>
    </div>
</div>

<div class="sales-container">
    <div class="billing-section" style="border-top-color: var(--primary);">
        <h3>üìú Recent Bill History</h3>
        <table>
            <thead>
                <tr><th>Date & Time</th><th>Inv #</th><th>Customer</th><th>Total</th><th>Status</th><th>Actions</th></tr>
            </thead>
            <tbody id="historyBody"></tbody>
        </table>
    </div>
</div>

<div id="qrcode" style="display:none;"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, increment, query, orderBy, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyD3So-in02rbcWD7OmuiRXzySQYgCR7iVI",
        authDomain: "mg-tradere.firebaseapp.com",
        projectId: "mg-tradere",
        storageBucket: "mg-tradere.firebasestorage.app",
        messagingSenderId: "318790809953",
        appId: "1:318790809953:web:5e829277f6d161e9942d20"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let allProducts = [], cart = [], selectedItem = null;
    let isEditing = false, editDocId = null;

    const sellerID = localStorage.getItem('logged_seller_id') || "m-haroon-123"; 
    document.getElementById('sellerIDLabel').innerText = sellerID;

    // Load Stock into Datalist (Search by Name and Code)
    onSnapshot(collection(db, "products"), snap => {
        allProducts = [];
        let listHtml = "";
        snap.forEach(d => {
            let p = {id: d.id, ...d.data()};
            allProducts.push(p);
            let displayString = `${p.code ? p.code + ' - ' : ''}${p.name}`;
            listHtml += `<option value="${displayString}">Available Stock: ${p.qty}</option>`;
        });
        document.getElementById('productList').innerHTML = listHtml;
    });

    // Load History with Delete Protection
    onSnapshot(query(collection(db, "sales"), orderBy("date", "desc")), snap => {
        let html = "";
        snap.forEach(d => {
            let s = d.data();
            let delStatus = s.deleteRequest ? '<br><small style="color:orange;">[Delete Pending]</small>' : '';
            html += `<tr>
                <td>${s.date.replace('T',' ')}</td>
                <td><b>${s.inv}</b>${delStatus}</td>
                <td>${s.customer}</td>
                <td>Rs. ${s.total}</td>
                <td style="color:${s.status==='UDHAR'?'red':'green'}">${s.status}</td>
                <td>
                    <button class="btn-action" onclick="printBill('${d.id}')" title="Print">üñ®Ô∏è</button>
                    <button class="btn-action" onclick="editBill('${d.id}')" style="color:var(--secondary)" title="Edit">üìù</button>
                    <button class="btn-action" onclick="requestDelete('${d.id}')" style="color:red" title="Request Delete">üóëÔ∏è</button>
                </td>
            </tr>`;
        });
        document.getElementById('historyBody').innerHTML = html;
        window.currentSales = snap.docs.map(d => ({id: d.id, ...d.data()}));
    });

    window.checkPrice = (val) => {
        const product = allProducts.find(p => {
            let combined = `${p.code ? p.code + ' - ' : ''}${p.name}`;
            return combined === val || p.name === val || p.code === val;
        });

        if(product) {
            selectedItem = product;
            document.getElementById('itemPrice').value = product.price || product.sale;
            document.getElementById('stockAvailable').innerText = "Stock: " + product.qty;
            document.getElementById('stockAvailable').style.color = product.qty < 5 ? "red" : "green";
        }
    };

    window.addToCart = () => {
        if(!selectedItem) return alert("Please select a product from the list!");
        let q = Number(document.getElementById('itemQty').value);
        let p = Number(document.getElementById('itemPrice').value);
        let d = Number(document.getElementById('itemDisc').value);
        
        if(q > selectedItem.qty && !isEditing) {
            alert("Not enough stock! Available: " + selectedItem.qty);
            return;
        }

        let total = (p * q) - (p * q * d / 100);
        cart.push({ id: selectedItem.id, name: selectedItem.name, price: p, qty: q, disc: d, total: total });
        renderCart();
        
        // Reset Item Bar
        document.getElementById('itemSearch').value = "";
        document.getElementById('itemPrice').value = "";
        document.getElementById('stockAvailable').innerText = "Stock: 0";
        selectedItem = null;
    };

    function renderCart() {
        let h = ""; let gt = 0;
        cart.forEach((it, i) => { 
            gt += it.total; 
            h += `<tr><td>${it.name}</td><td>${it.price}</td><td>${it.qty}</td><td>${it.total.toFixed(0)}</td><td onclick="cart.splice(${i},1);renderCart()" style="cursor:pointer; color:red; font-weight:bold;">‚úñ</td></tr>`; 
        });
        document.getElementById('billBody').innerHTML = h;
        document.getElementById('grandTotal').innerText = gt.toFixed(0);
    }

    window.saveInvoice = async (status) => {
        if(!cart.length) return alert("Cart is empty!");
        
        const bill = {
            inv: document.getElementById('billInv').value,
            date: document.getElementById('billDate').value,
            customer: document.getElementById('custName').value || "Guest",
            phone: document.getElementById('custPhone').value,
            area: document.getElementById('custArea').value,
            items: cart,
            total: Number(document.getElementById('grandTotal').innerText),
            status: status,
            billedBy: sellerID,
            lastModified: new Date().toLocaleString()
        };

        try {
            if(isEditing && editDocId) {
                await updateDoc(doc(db, "sales", editDocId), bill);
                alert("‚úÖ Invoice Updated Successfully!");
            } else {
                const docRef = await addDoc(collection(db, "sales"), bill);
                for(let it of cart) { await updateDoc(doc(db, "products", it.id), { qty: increment(-it.qty) }); }
                editDocId = docRef.id;
            }
            printBill(editDocId);
            location.reload();
        } catch (e) { alert("Error saving bill: " + e.message); }
    };

    window.editBill = (id) => {
        const pass = prompt("Enter Password to Edit (Malik12345):");
        if(pass !== "Malik12345") return alert("Unauthorized Access!");
        
        const bill = window.currentSales.find(s => s.id === id);
        isEditing = true;
        editDocId = id;

        // Visual Indicator
        document.getElementById('billPanel').classList.add('edit-mode');
        document.getElementById('editIndicator').style.display = "block";
        document.getElementById('editingInvLabel').innerText = bill.inv;
        document.getElementById('cancelBtn').style.display = "inline-block";
        document.getElementById('saveBtn').innerText = "Update Cash Bill";
        document.getElementById('udharBtn').innerText = "Update Udhar";

        // Load Fields
        document.getElementById('billInv').value = bill.inv;
        document.getElementById('billDate').value = bill.date;
        document.getElementById('custName').value = bill.customer;
        document.getElementById('custPhone').value = bill.phone;
        document.getElementById('custArea').value = bill.area || "";
        cart = [...bill.items];
        renderCart();
        window.scrollTo(0,0);
    };

    window.cancelEdit = () => { location.reload(); };

    window.requestDelete = async (id) => {
        if(confirm("Send delete request to Admin for approval?")) {
            await updateDoc(doc(db, "sales", id), { deleteRequest: true });
            alert("Request sent! Admin will approve the deletion.");
        }
    };

    window.printBill = (id) => {
        const bill = window.currentSales.find(s => s.id === id);
        if(!bill) return;

        const qrContent = `Inv:${bill.inv}|Total:${bill.total}|Seller:${bill.billedBy}`;
        document.getElementById('qrcode').innerHTML = "";
        new QRCode(document.getElementById("qrcode"), { text: qrContent, width: 80, height: 80 });

        setTimeout(() => {
            const qrImg = document.querySelector('#qrcode img').src;
            let pW = window.open('', '', 'width=800,height=600');
            let itemsHtml = bill.items.map(it => `<tr><td>${it.name}</td><td>${it.qty}</td><td>${it.price}</td><td>${it.total.toFixed(0)}</td></tr>`).join('');
            pW.document.write(`
                <html><head><style>body{font-family:sans-serif;padding:20px;} table{width:100%;border-collapse:collapse;margin-top:10px;} th,td{border-bottom:1px solid #ddd;padding:8px;text-align:left;}</style></head>
                <body><center><h2>1 MG TRADER</h2><p>Official Sales Receipt</p></center>
                <hr>
                <p><b>Invoice:</b> ${bill.inv} | <b>Date:</b> ${bill.date.replace('T', ' ')}</p>
                <p><b>Customer:</b> ${bill.customer} | ${bill.phone}</p>
                <table><thead><tr><th>Item</th><th>Qty</th><th>Rate</th><th>Total</th></tr></thead><tbody>${itemsHtml}</tbody></table>
                <div style="display:flex;justify-content:space-between;margin-top:20px;border-top:2px solid #000;padding-top:10px;">
                    <div><h3>Net Total: Rs. ${bill.total}</h3><p>Billed By: ${bill.billedBy}</p></div>
                    <img src="${qrImg}" />
                </div><script>window.print();window.close();<\/script></body></html>
            `);
            pW.document.close();
        }, 500);
    };

    window.logout = () => { localStorage.removeItem('logged_seller_id'); window.location.href = "login.html"; };

    // Initial Setup
    document.getElementById('billDate').value = new Date().toISOString().slice(0, 16);
    document.getElementById('billInv').value = "INV-" + Math.floor(100000 + Math.random() * 900000);
</script>

<script>
    const display = document.getElementById('calc-display');
    function calcIn(v) { if(display.value === "0") display.value = v; else display.value += v; }
    function calcC() { display.value = "0"; }
    function calcRes() { try { display.value = eval(display.value); } catch(e) { display.value = "Error"; } }
</script>
</body>
</html>