<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>1 MG Trader | Smart Stock Management</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; margin: 0; padding-bottom: 80px; }
        .main-header { background: #2c3e50; color: white; padding: 15px; text-align: center; }
        
        /* Navigation Bar */
        .nav-bar { background: #34495e; padding: 10px; text-align: center; }
        .nav-bar a { color: white; text-decoration: none; margin: 0 15px; font-weight: bold; font-size: 14px; }
        .nav-bar a:hover { color: #3498db; }

        .container { padding: 20px; max-width: 1500px; margin: auto; }

        /* Master Buttons Section */
        .master-bar { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .btn-master { flex: 1; padding: 12px; border: none; border-radius: 8px; color: white; cursor: pointer; font-weight: bold; font-size: 13px; text-transform: uppercase; transition: 0.3s; min-width: 160px; }
        .btn-comp { background: #8e44ad; }
        .btn-cat { background: #2980b9; }
        .btn-sub { background: #16a085; }
        .btn-del { background: #c0392b; }

        /* Input Form Card */
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .grid-inputs { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; }
        
        label { font-size: 11px; font-weight: bold; color: #3498db; text-transform: uppercase; display: block; margin-bottom: 5px; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 13px; }
        
        .btn-save { background: #27ae60; color: white; width: 100%; padding: 15px; font-size: 18px; margin-top: 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 900; letter-spacing: 1px; }
        .btn-save:hover { background: #219150; transform: scale(1.01); }

        /* Table Section */
        .table-title { background: #2c3e50; color: white; padding: 10px 20px; border-radius: 8px 8px 0 0; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 0 0 8px 8px; overflow: hidden; }
        th { background: #34495e; color: white; padding: 12px; text-align: left; font-size: 12px; }
        td { padding: 10px; border-bottom: 1px solid #eee; font-size: 13px; }
        
        .low-stock { background: #ff7675 !important; color: white; }
        .profit-text { color: #27ae60; font-weight: bold; }
        
        /* Search Box */
        #pSearch { width: 100%; padding: 12px; margin-bottom: 15px; border: 2px solid #3498db; border-radius: 8px; font-size: 15px; outline: none; }

        /* Footer Ticker */
        footer { position: fixed; bottom: 0; left: 0; width: 100%; background: #2c3e50; color: white; padding: 10px 0; overflow: hidden; z-index: 100; border-top: 3px solid #e74c3c; }
        .ticker-wrapper { white-space: nowrap; animation: marquee 25s linear infinite; display: inline-block; font-weight: bold; }
        @keyframes marquee { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }

        .btn-action { padding: 5px 8px; border: none; border-radius: 4px; cursor: pointer; color: white; margin-right: 2px; }
        .btn-edit { background: #f39c12; }
        .btn-delete { background: #e74c3c; }
    </style>
</head>
<body>

<header class="main-header">
    <h1>1 MG TRADER | MANAGEMENT SYSTEM</h1>
</header>

<div class="nav-bar">
    <a href="index.html">üè† Dashboard</a>
    <a href="products.html">üì¶ Inventory</a>
    <a href="orders.html">üìù Orders</a>
    <a href="companies.html">üè¢ Companies</a>
</div>

<div class="container">
    <div class="master-bar">
        <button class="btn-master btn-comp" onclick="manageMaster('Company')">üè¢ Add Company</button>
        <button class="btn-master btn-cat" onclick="manageMaster('Category')">üìÅ Add Category</button>
        <button class="btn-master btn-sub" onclick="manageMaster('Sub-Category')">üìÇ Add Sub-Category</button>
        <button class="btn-master btn-del" onclick="deleteMaster()">üóëÔ∏è Delete Master List</button>
    </div>

    <div class="card">
        <div class="grid-inputs">
            <div><label>Inv#</label><input type="text" id="pInv" placeholder="INV-001"></div>
            <div><label>Code</label><input type="text" id="pCode" placeholder="PC-101"></div>
            <div>
                <label>Company</label>
                <input list="compList" id="pComp" placeholder="Select Company">
                <datalist id="compList"></datalist>
            </div>
            <div>
                <label>Category</label>
                <input list="catList" id="pCat" placeholder="Select Category">
                <datalist id="catList"></datalist>
            </div>
            <div>
                <label>Sub-Cat</label>
                <input list="subList" id="pSub" placeholder="Select Sub-Cat">
                <datalist id="subList"></datalist>
            </div>
            <div><label>Product Name</label><input type="text" id="pName"></div>
            <div><label>Cost Price</label><input type="number" id="pCost" oninput="calcProfit()"></div>
            <div><label>Sale Price</label><input type="number" id="pSale" oninput="calcProfit()"></div>
            <div><label>Profit</label><input type="text" id="pProfit" readonly style="background:#f9f9f9; color:green; font-weight:bold;"></div>
            <div><label>Stock Qty</label><input type="number" id="pQty"></div>
            <div><label>Min Limit</label><input type="number" id="pMin" value="5"></div>
            <div>
                <label>Season</label>
                <select id="pSeason">
                    <option>All Season</option>
                    <option>Winter</option>
                    <option>Summer</option>
                </select>
            </div>
            <div><label>Expiry Date</label><input type="date" id="pExp"></div>
        </div>
        <button class="btn-save" onclick="addProduct()">üöÄ SAVE PRODUCT TO CLOUD</button>
    </div>

    <div class="table-title">
        <span>üìä Stock Inventory List</span>
        <span id="liveStatus">System Online üü¢</span>
    </div>
    <div class="card" style="padding:0;">
        <input type="text" id="pSearch" onkeyup="searchProduct()" placeholder="üîç Search by Inv#, Code, Name or Company...">
        <table>
            <thead>
                <tr>
                    <th>Inv#</th>
                    <th>Code</th>
                    <th>Company</th>
                    <th>Product Name</th>
                    <th>Cost</th>
                    <th>Sale</th>
                    <th>Qty</th>
                    <th>Season</th>
                    <th>Expiry</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="productBody">
                </tbody>
        </table>
    </div>
</div>

<footer>
    <div class="ticker-wrapper" id="tickerText">
        Connecting to Cloud Database... Please wait.
    </div>
</footer>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyD3So-in02rbcWD7OmuiRXzySQYgCR7iVI",
        authDomain: "mg-tradere.firebaseapp.com",
        projectId: "mg-tradere",
        storageBucket: "mg-tradere.firebasestorage.app",
        messagingSenderId: "318790809953",
        appId: "1:318790809953:web:5e829277f6d161e9942d20"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const stockCol = collection(db, "products");

    // --- Master Data Handling ---
    window.manageMaster = function(type) {
        let val = prompt(`Enter New ${type}:`);
        if(val) {
            let masters = JSON.parse(localStorage.getItem('mg_masters')) || { Company: [], Category: [], SubCategory: [] };
            if(type === 'Company') masters.Company.push(val);
            else if(type === 'Category') masters.Category.push(val);
            else if(type === 'Sub-Category') masters.SubCategory.push(val);
            localStorage.setItem('mg_masters', JSON.stringify(masters));
            renderMasterLists();
        }
    };

    window.deleteMaster = function() {
        if(prompt("Admin Password:") === "Malik12345") {
            localStorage.removeItem('mg_masters');
            location.reload();
        }
    };

    function renderMasterLists() {
        let masters = JSON.parse(localStorage.getItem('mg_masters')) || { Company: [], Category: [], SubCategory: [] };
        document.getElementById('compList').innerHTML = (masters.Company || []).map(x => `<option value="${x}">`).join('');
        document.getElementById('catList').innerHTML = (masters.Category || []).map(x => `<option value="${x}">`).join('');
        document.getElementById('subList').innerHTML = (masters.SubCategory || []).map(x => `<option value="${x}">`).join('');
    }

    // --- Profit Calculation ---
    window.calcProfit = function() {
        let cost = Number(document.getElementById('pCost').value) || 0;
        let sale = Number(document.getElementById('pSale').value) || 0;
        document.getElementById('pProfit').value = (sale - cost);
    };

    // --- Add/Update Product ---
    let editId = null;
    window.addProduct = async function() {
        const product = {
            inv: document.getElementById('pInv').value,
            code: document.getElementById('pCode').value,
            company: document.getElementById('pComp').value,
            category: document.getElementById('pCat').value,
            sub: document.getElementById('pSub').value,
            name: document.getElementById('pName').value.trim(),
            cost: Number(document.getElementById('pCost').value),
            sale: Number(document.getElementById('pSale').value),
            qty: Number(document.getElementById('pQty').value),
            min: Number(document.getElementById('pMin').value),
            season: document.getElementById('pSeason').value,
            expiry: document.getElementById('pExp').value,
            time: new Date().toLocaleString()
        };

        if(!product.name) return alert("Please enter Product Name!");

        try {
            if(editId) {
                await updateDoc(doc(db, "products", editId), product);
                editId = null;
                alert("‚úÖ Updated!");
            } else {
                await addDoc(stockCol, product);
                alert("‚úÖ Saved to Cloud!");
            }
            document.querySelectorAll('input').forEach(i => i.value = "");
            document.getElementById('pProfit').value = "";
        } catch (e) { alert("Error: " + e.message); }
    };

    // --- Live Data Load ---
    onSnapshot(stockCol, (snapshot) => {
        let html = "";
        let low = 0; let expSoon = 0;
        snapshot.forEach(docSnap => {
            const p = docSnap.data();
            const id = docSnap.id;
            if(p.qty <= p.min) low++;
            
            // Expiry Check
            if(p.expiry) {
                let diff = (new Date(p.expiry) - new Date()) / (1000*60*60*24);
                if(diff < 60) expSoon++;
            }

            html += `
                <tr class="${p.qty <= p.min ? 'low-stock' : ''}">
                    <td>${p.inv || '-'}</td>
                    <td>${p.code || '-'}</td>
                    <td>${p.company || '-'}</td>
                    <td><b>${p.name}</b></td>
                    <td>${p.cost}</td>
                    <td>${p.sale}</td>
                    <td><b>${p.qty}</b></td>
                    <td>${p.season}</td>
                    <td>${p.expiry || '-'}</td>
                    <td>
                        <button class="btn-action btn-edit" onclick="editProduct('${id}', ${JSON.stringify(p).replace(/"/g, '&quot;')})">‚úèÔ∏è</button>
                        <button class="btn-action btn-delete" onclick="deleteProduct('${id}')">üóëÔ∏è</button>
                    </td>
                </tr>
            `;
        });
        document.getElementById('productBody').innerHTML = html;
        document.getElementById('tickerText').innerText = `‚ö†Ô∏è ALERT: ${low} Items Low Stock | üïí EXPIRE: ${expSoon} Items Expiring Soon | 1 MG TRADER System Live üü¢ | Secure Cloud Database v4.0`;
        renderMasterLists();
    });

    window.deleteProduct = async (id) => {
        if(prompt("Admin Password:") === "Malik12345") {
            await deleteDoc(doc(db, "products", id));
        }
    };

    window.editProduct = (id, data) => {
        editId = id;
        document.getElementById('pInv').value = data.inv;
        document.getElementById('pCode').value = data.code;
        document.getElementById('pComp').value = data.company;
        document.getElementById('pCat').value = data.category;
        document.getElementById('pSub').value = data.sub;
        document.getElementById('pName').value = data.name;
        document.getElementById('pCost').value = data.cost;
        document.getElementById('pSale').value = data.sale;
        document.getElementById('pQty').value = data.qty;
        document.getElementById('pMin').value = data.min;
        document.getElementById('pSeason').value = data.season;
        document.getElementById('pExp').value = data.expiry;
        calcProfit();
        window.scrollTo(0,0);
    };

    window.searchProduct = () => {
        let val = document.getElementById('pSearch').value.toUpperCase();
        let rows = document.getElementById('productBody').getElementsByTagName('tr');
        for(let r of rows) { r.style.display = r.innerText.toUpperCase().includes(val) ? "" : "none"; }
    };
</script>

</body>
</html>