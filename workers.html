<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>1 MG Trader | Staff Master Cloud</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #1e1b4b; --accent: #fbbf24; --success: #10b981; --danger: #ef4444; --card-bg: #1e293b; }
        body { font-family: 'Inter', sans-serif; background: #f0f4ff; margin: 0; padding-bottom: 100px; color: #1e293b; }

        /* Header */
        .header { background: var(--primary); color: white; padding: 20px; text-align: center; border-bottom: 4px solid var(--accent); position: relative; }
        .user-badge { position: absolute; top: 20px; right: 30px; background: rgba(251,191,36,0.2); padding: 5px 15px; border-radius: 30px; color: var(--accent); font-weight: bold; border: 1px solid var(--accent); }

        .container { max-width: 1500px; margin: 25px auto; padding: 0 25px; }
        .main-grid { display: grid; grid-template-columns: 400px 1fr; gap: 25px; }

        /* Form & Cards */
        .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .full { grid-column: span 2; }
        label { font-size: 11px; font-weight: 800; color: #4338ca; text-transform: uppercase; margin-bottom: 5px; display: block; }
        input, select { width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 10px; background: #f8fafc; }

        /* Table Styles */
        .staff-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .staff-table th { background: #f8fafc; padding: 15px; text-align: left; font-size: 12px; color: #64748b; border-bottom: 2px solid #edf2f7; }
        .staff-table td { padding: 15px; border-bottom: 1px solid #f1f5f9; font-size: 14px; }

        /* Attendance Calendar */
        #calModal { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:white; padding:25px; border-radius:20px; box-shadow:0 0 50px rgba(0,0,0,0.3); z-index:1001; width:350px; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-top: 15px; }
        .cal-day { width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; border-radius: 8px; font-size: 12px; cursor: pointer; border: 1px solid #eee; transition: 0.3s; }
        .is-present { background: var(--success) !important; color: white; font-weight: bold; box-shadow: 0 4px 10px rgba(16,185,129,0.3); }
        .is-absent { background: #f1f5f9; color: #94a3b8; }

        /* Action Buttons */
        .btn-act { width: 35px; height: 35px; border-radius: 8px; border: none; cursor: pointer; margin-right: 5px; transition: 0.2s; }
        .btn-edit { background: #e0e7ff; color: #4338ca; }
        .btn-print { background: #fef3c7; color: #d97706; }
        .btn-cal { background: #d1fae5; color: #059669; }

        /* ID Card for Printing (Hidden on screen) */
        #printArea { display: none; }
        @media print {
            body * { visibility: hidden; }
            #printArea, #printArea * { visibility: visible; }
            #printArea { display: block; position: absolute; left: 0; top: 0; width: 100%; }
        }

        /* Footer */
        footer { position: fixed; bottom: 0; width: 100%; background: var(--primary); color: white; padding: 12px; border-top: 4px solid var(--accent); }
        .ticker { display: flex; justify-content: space-around; font-weight: bold; font-size: 14px; }
    </style>
</head>
<body>

<div class="header no-print">
    <div class="user-badge">üõ°Ô∏è Admin: <span id="adminUser">Loading...</span></div>
    <h1>‚ú® 1 MG TRADER | STAFF CLOUD</h1>
</div>

<div class="container no-print">
    <div class="main-grid">
        <div class="card">
            <h3 id="formTitle" style="color:var(--primary); margin-top:0;">üìù Employee Registration</h3>
            <div class="form-grid">
                <div class="full"><label>Full Name</label><input type="text" id="wName"></div>
                <div><label>Phone Number</label><input type="text" id="wPhone"></div>
                <div><label>Job Role</label>
                    <select id="wRole">
                        <option>Order Booker</option><option>Salesman</option><option>Driver</option><option>Helper</option>
                    </select>
                </div>
                <div><label>Blood Group</label>
                    <select id="wBlood">
                        <option>A+</option><option>B+</option><option>O+</option><option>O-</option><option>AB+</option>
                    </select>
                </div>
                <div><label>Salary</label><input type="number" id="wSalary"></div>
                <div><label>Height</label><input type="text" id="wHeight" placeholder="5.8 ft"></div>
                <div class="full"><label>ID Card / CNIC</label><input type="text" id="wCNIC"></div>
                <div class="full"><label>Profile Image</label><input type="file" accept="image/*" onchange="encodeImg(this)"></div>
                <div class="full"><label>Login Password</label><input type="password" id="wPass"></div>
            </div>
            <input type="hidden" id="editId">
            <button onclick="saveWorker()" style="width:100%; background:var(--primary); color:var(--accent); padding:15px; border-radius:12px; margin-top:20px; cursor:pointer; font-weight:bold; border:none;">üöÄ SAVE & SYNC</button>
        </div>

        <div class="card">
            <h3 style="margin-top:0; color:var(--primary);">üë• Staff Directory</h3>
            <table class="staff-table">
                <thead>
                    <tr>
                        <th>Employee</th>
                        <th>Approval</th>
                        <th>Monthly Attendance</th>
                        <th>Net Pay</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="staffBody"></tbody>
            </table>
        </div>
    </div>
</div>

<div id="calModal" class="no-print">
    <h3 id="calWorkerName" style="margin:0; color:var(--primary);">Attendance</h3>
    <div class="cal-grid" id="calGrid"></div>
    <button onclick="document.getElementById('calModal').style.display='none'" style="width:100%; background:var(--primary); color:white; padding:10px; border-radius:10px; border:none; margin-top:15px; cursor:pointer;">Close & Save</button>
</div>

<div id="printArea"></div>

<footer class="no-print">
    <div class="ticker">
        <span>‚úÖ Active Staff: <span id="countActive">0</span></span>
        <span>üö´ Inactive: <span id="countInactive">0</span></span>
        <span>üïí Today: <span id="liveClock"></span></span>
    </div>
</footer>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, onSnapshot, doc, setDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyD3So-in02rbcWD7OmuiRXzySQYgCR7iVI",
        authDomain: "mg-tradere.firebaseapp.com",
        projectId: "mg-tradere",
        storageBucket: "mg-tradere.firebasestorage.app",
        messagingSenderId: "318790809953",
        appId: "1:318790809953:web:5e829277f6d161e9942d20"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let currentData = [];
    let base64Photo = "";

    window.encodeImg = (el) => {
        const reader = new FileReader();
        reader.onload = (e) => base64Photo = e.target.result;
        reader.readAsDataURL(el.files[0]);
    };

    onSnapshot(collection(db, "workers"), async (snap) => {
        const body = document.getElementById('staffBody');
        body.innerHTML = "";
        currentData = [];
        let act = 0, inact = 0;

        snap.forEach(d => {
            const w = d.data();
            const id = d.id;
            currentData.push({id, ...w});

            let att = w.attendance || {};
            let presentCount = Object.values(att).filter(v => v === 'P').length;
            let earned = ((w.salary || 0) / 30) * presentCount;

            if(w.status === 'Active') act++; else inact++;

            body.innerHTML += `
                <tr>
                    <td><b>${w.name}</b><br><small>${w.role}</small></td>
                    <td><span style="color:${w.status === 'Active' ? 'green' : 'red'}; font-weight:bold;">${w.status}</span></td>
                    <td><button class="btn-act btn-cal" onclick="openAttendance('${id}')"><i class="fa fa-calendar-check"></i></button> ${presentCount}/30</td>
                    <td style="font-weight:bold; color:var(--success)">Rs. ${earned.toFixed(0)}</td>
                    <td>
                        <button class="btn-act btn-edit" onclick="editWorker('${id}')"><i class="fa fa-edit"></i></button>
                        <button class="btn-act btn-print" onclick="printIDCard('${id}')"><i class="fa fa-print"></i></button>
                    </td>
                </tr>
            `;
        });
        document.getElementById('countActive').innerText = act;
        document.getElementById('countInactive').innerText = inact;
    });

    window.saveWorker = async () => {
        const id = document.getElementById('editId').value || "MG-" + Date.now();
        const data = {
            name: document.getElementById('wName').value,
            phone: document.getElementById('wPhone').value,
            role: document.getElementById('wRole').value,
            blood: document.getElementById('wBlood').value,
            height: document.getElementById('wHeight').value,
            cnic: document.getElementById('wCNIC').value,
            salary: parseFloat(document.getElementById('wSalary').value),
            pass: document.getElementById('wPass').value
        };
        if(base64Photo) data.photo = base64Photo;
        await setDoc(doc(db, "workers", id), data, { merge: true });
        alert("Worker Synced!");
        location.reload();
    };

    window.editWorker = (id) => {
        const w = currentData.find(x => x.id === id);
        document.getElementById('editId').value = id;
        document.getElementById('wName').value = w.name;
        document.getElementById('wSalary').value = w.salary;
        document.getElementById('formTitle').innerText = "‚úèÔ∏è Update Staff";
        window.scrollTo(0,0);
    };

    window.openAttendance = (id) => {
        const w = currentData.find(x => x.id === id);
        if(w.status !== 'Active') return alert("Admin Approval Required! (Staff is Inactive)");
        
        document.getElementById('calWorkerName').innerText = w.name;
        const grid = document.getElementById('calGrid');
        grid.innerHTML = "";
        let att = w.attendance || {};

        for(let i=1; i<=30; i++) {
            let status = att[i] || 'A';
            grid.innerHTML += `<div class="cal-day ${status === 'P' ? 'is-present' : 'is-absent'}" 
                onclick="markDay('${id}', ${i}, '${status}')">${i}</div>`;
        }
        document.getElementById('calModal').style.display = 'block';
    };

    window.markDay = async (id, day, current) => {
        const next = current === 'P' ? 'A' : 'P';
        let up = {}; up[`attendance.${day}`] = next;
        await setDoc(doc(db, "workers", id), up, { merge: true });
        openAttendance(id); // Re-render
    };

    window.printIDCard = (id) => {
        const w = currentData.find(x => x.id === id);
        const printArea = document.getElementById('printArea');
        printArea.innerHTML = `
            <div style="width:250px; height:400px; background:#1e293b; color:white; border-radius:15px; padding:20px; text-align:center; border:2px solid var(--accent);">
                <h2 style="color:var(--accent); margin:0;">1 MG TRADER</h2>
                <img src="${w.photo}" style="width:100px; height:100px; border-radius:10px; border:2px solid var(--accent); margin:15px 0;">
                <h3>${w.name}</h3>
                <p>${w.role}</p>
                <hr>
                <div style="text-align:left; font-size:12px;">
                    <p>ID: ${id}</p>
                    <p>CNIC: ${w.cnic}</p>
                    <p>BLOOD: ${w.blood}</p>
                </div>
            </div>
        `;
        window.print();
    };

    document.getElementById('adminUser').innerText = localStorage.getItem('logged_admin_id') || "Malik Admin";
    setInterval(() => { document.getElementById('liveClock').innerText = new Date().toLocaleTimeString(); }, 1000);
</script>
</body>
</html>