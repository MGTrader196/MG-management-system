<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Control Panel | 1 MG Trader</title>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        // Auth library add kar di gayi hai
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAz5XvXfS-m0WjG8j9O2K9L6q4R3T1Y0", 
            authDomain: "mg-trader.firebaseapp.com",
            projectId: "mg-trader",
            storageBucket: "mg-trader.appspot.com",
            messagingSenderId: "367341339178",
            appId: "1:367341339178:web:15848e470878a876a386b0"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Background mein login karne ka function
        async function authenticateAdmin() {
            try {
                await signInAnonymously(auth);
                console.log("Login Successful!");
                startSync(); // Login ke baad data start hoga
            } catch (error) {
                console.error("Login Failed:", error);
                alert("Database connection error!");
            }
        }

        function startSync() {
            // Orders Data
            onSnapshot(collection(db, "orders"), (snap) => {
                let html = "";
                snap.forEach(d => {
                    const o = d.data();
                    if(o.status === "Pending" || !o.status) {
                        html += `<tr><td><b>${o.shop}</b></td><td>Rs. ${o.total}</td><td><button class="btn-ok" onclick="approveOrder('${d.id}')">Approve</button></td></tr>`;
                    }
                });
                document.getElementById('orderBody').innerHTML = html || "<tr><td colspan='3' style='text-align:center;'>No Pending Orders</td></tr>";
            });

            // Workers & Passwords
            onSnapshot(collection(db, "users"), (snap) => {
                let wHtml = ""; let pHtml = "";
                snap.forEach(d => {
                    const u = d.data();
                    wHtml += `<tr><td>${u.name}</td><td>${u.role}</td><td>Active</td></tr>`;
                    pHtml += `<tr><td><b>${u.role}</b></td><td>${u.id}</td><td style="color:red; font-weight:bold;">${u.pass}</td></tr>`;
                });
                document.getElementById('workerBody').innerHTML = wHtml;
                document.getElementById('passBody').innerHTML = pHtml;
            });

            // Alerts
            onSnapshot(collection(db, "products"), (snap) => {
                let aHtml = "";
                snap.forEach(d => {
                    const p = d.data();
                    if(p.qty <= (p.min || 5)) {
                        aHtml += `<div class="alert-box">‚ö†Ô∏è <b>Stock Alert:</b> ${p.name} is Low (${p.qty} left)</div>`;
                    }
                });
                document.getElementById('alertSection').innerHTML = aHtml || "<div>‚úÖ System Status: All Good.</div>";
            });
        }

        window.approveOrder = async (id) => {
            if(confirm("Mark as Delivered?")) {
                try {
                    await updateDoc(doc(db, "orders", id), { status: "Delivered" });
                    alert("Order Approved Successfully!");
                } catch (e) {
                    console.error(e);
                    alert("Error: Action not allowed.");
                }
            }
        };

        // Onload par authentication run hogi
        window.onload = authenticateAdmin;

        window.openTab = (name, e) => {
            document.querySelectorAll('.content-section').forEach(s => s.style.display = 'none');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(name).style.display = 'block';
            e.currentTarget.classList.add('active');
        };
    </script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; padding-bottom: 120px; }
        .admin-header { background: #2c3e50; color: white; padding: 20px; text-align: center; }
        .nav-bar { background: #34495e; padding: 12px; text-align: center; }
        .nav-bar a { color: white; text-decoration: none; margin: 0 15px; font-weight: bold; font-size: 14px; }
        .container { max-width: 1000px; margin: 20px auto; padding: 0 20px; }
        .tab-wrapper { display: flex; background: #ddd; border-radius: 8px 8px 0 0; }
        .tab-btn { flex: 1; padding: 15px; border: none; cursor: pointer; font-weight: bold; background: #ddd; }
        .tab-btn.active { background: white; border-top: 3px solid #f39c12; }
        .content-area { background: white; padding: 20px; border-radius: 0 0 8px 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); min-height: 350px; }
        .content-section { display: none; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
        .btn-ok { background: #27ae60; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; }
        .alert-box { background: #fff3e0; border-left: 5px solid #ff9800; padding: 12px; margin-bottom: 8px; border-radius: 4px; }
        footer { position: fixed; bottom: 0; width: 100%; background: #2c3e50; color: white; text-align: center; padding: 10px; border-top: 3px solid #f39c12; }
    </style>
</head>
<body>

<div class="admin-header"><h2>1 MG TRADER | ADMIN CONTROL</h2></div>

<div class="nav-bar">
    <a href="index.html">üè† DASHBOARD</a>
    <a href="products.html">üì¶ STOCK</a>
    <a href="customers.html">üë§ CUSTOMERS</a>
</div>

<div class="container">
    <div class="tab-wrapper">
        <button class="tab-btn active" onclick="openTab('orders', event)">üì¶ Orders</button>
        <button class="tab-btn" onclick="openTab('workers', event)">üë• Workers</button>
        <button class="tab-btn" onclick="openTab('alerts', event)">‚ö†Ô∏è Alerts</button>
        <button class="tab-btn" onclick="openTab('passwords', event)">üîí Passwords</button>
    </div>

    <div class="content-area">
        <div id="orders" class="content-section" style="display: block;">
            <table><thead><tr><th>Shop</th><th>Total</th><th>Action</th></tr></thead><tbody id="orderBody"></tbody></table>
        </div>
        <div id="workers" class="content-section">
            <table><thead><tr><th>Name</th><th>Role</th><th>Status</th></tr></thead><tbody id="workerBody"></tbody></table>
        </div>
        <div id="alerts" class="content-section">
            <div id="alertSection"></div>
        </div>
        <div id="passwords" class="content-section">
            <table><thead><tr><th>Role</th><th>ID</th><th>Password</th></tr></thead><tbody id="passBody"></tbody></table>
        </div>
    </div>
</div>

<footer>DESIGNED BY: <b>MALIK FAISAL</b></footer>

</body>
</html>